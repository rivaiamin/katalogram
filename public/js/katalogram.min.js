var kgApp=angular.module("kgApp",["ui.router","ngTagsInput","satellizer","cropme","angular-input-stars","ui.knob","ngTouch","superswipe","validation.match"]),host=window.location.hostname;kgApp.constant("kgConfig",{site:"//"+host+"/",api:"//api."+host+"/",files:"//files."+host+"/",embedly:"8081dea79e164014bcd7cd7e1ab2363a"}).config(["$stateProvider","$httpProvider","$urlRouterProvider","$authProvider","$locationProvider","kgConfig",function(t,e,o,a,c,n){t.state("home",{url:"/",templateUrl:"catalogList.html",controller:"catalogList"}).state("catalog",{url:"/catalog",templateUrl:"catalogList",controller:"catalogList"}).state("catalogCategory",{url:"/catalog/category/:categoryId",templateUrl:"catalogList.html",controller:"catalogList"}).state("catalogDetail",{url:"/catalog/:productId",templateUrl:"catalogDetail.html",controller:"catalogDetail"}).state("catalogEdit",{url:"/catalog/:productId/edit",templateUrl:"editCatalog.html",controller:"editCatalog"}).state("profile",{url:"/{username:[a-zA-Z1-9.-]*}",templateUrl:"memberProfile.html",controller:"memberProfile"}).state("editProfile",{url:"/:username/edit",templateUrl:"editMember.html",controller:"editMember"}),c.html5Mode(!0),o.otherwise("/catalog"),e.defaults.useXDomain=!0,a.loginUrl=n.api+"member/login",a.signupUrl=n.api+"member/register",a.facebook({clientId:"1496399374007633",url:n.api+"auth/facebook"}),a.google({clientId:"13356134084-uo1b2bi0sn6vhvdslphhem7desofd5rt.apps.googleusercontent.com",url:n.api+"auth/google"})}]).controller("kgController",["$scope","$rootScope","$http","$state","$auth","$sce","$location","$interval","kgConfig",function(t,e,o,a,c,n,i,r,s){e.api=s.api,e.files=s.files,t.popup=function(){$(".browse").popup({inline:!0,hoverable:!0,delay:{show:300,hide:800}})},o.get(s.api+"category").success(function(o){e.categories=o.categories,t.popup()}),t.modal=UIkit.modal("#kg-modal"),t.feedback={},t.refreshToken=function(){o.get(s.api+"auth/refresh").then(function(t){var e=t.headers("Authorization");c.setToken(e)})["catch"](function(t){return!1})},t.getAuthUser=function(){o.get(s.api+"auth/user").success(function(o){e.user=o.user,t.popup()})},t.authenticate=function(e){c.authenticate(e).then(function(e){t.getAuthUser(),t.modal.hide()})["catch"](function(t){t.error?UIkit.notify(t.error):t.data?UIkit.notify(t.data.message,t.status):UIkit.notify(t)})},t.loginPage=function(){t.modalTemplate="loginMember.html",t.modal.show()},t.loginMember=function(e){c.login(e).then(function(e){t.modal.hide(),t.getAuthUser()})["catch"](function(t){UIkit.notify(t.data.message,t.status)})},t.registerPage=function(){t.modalTemplate="registerMember.html",t.modal.show()},t.registerMember=function(e){c.signup(e).then(function(e){c.setToken(e),t.getAuthUser(),t.modal.hide()})["catch"](function(t){UIkit.notify(t.data.message,t.status)})},t.isLogin=function(){return c.isAuthenticated()},t.logout=function(){c.logout(),t.loginPage()},t.catalogDetail=function(e){t.loader=!0,o.get(s.api+"catalog/"+e).success(function(e){catalog=e.product[0],catalog.product_desc=n.trustAsHtml(catalog.product_desc),catalog.product_data=n.trustAsHtml(catalog.product_data),catalog.num_plus=Object.keys(catalog.feedback_plus).length,catalog.num_minus=Object.keys(catalog.feedback_minus).length;var o=Object.keys(e.product[0].num_collect).length;0==o?catalog.num_collect=0:catalog.num_collect=catalog.num_collect[0].numCollect;for(var a=0,c=0,i=catalog.criteria,r=0;r<i.length;r++)0!=i[r].avg_criteria.length&&(a+=parseFloat(i[r].avg_criteria[0].criteria_rate)),c++;catalog.avg_rate=Number((a/c).toFixed(1)),t.knob={},t.knob.options={readOnly:!0,max:5,trackWidth:40,barWidth:30,trackColor:"#eee",barColor:"#0079ab"},t.productId=catalog.id,t.catalog=catalog,t.modalTemplate="catalogDetail.html",t.loader=!1})},t.embedPreview=function(t){var e='<a href="'+t+'" class="embedly-card preview-card">Embedly</a>';$(".embed-preview").html(e),embedly("card",".preview-card")},t.createCatalog=function(){t.modalTemplate="createCatalog.html",t.modal.show()},t.saveCatalog=function(e){o.post(s.api+"catalog",e).success(function(e){UIkit.notify(e.message,e.status),t.modal.hide(),a.go("catalogEdit",{productId:e.product_id})})},t.addCollect=function(){o.post(s.api+"catalog/"+t.productId+"/collect").success(function(e){UIkit.notify(e.message,e.status),"success"==e.status&&t.productDetail.num_collect++})},t.giveRate=function(e){var a={criteria_id:e.id,rate_value:e.avg_criteria[0].criteria_rate};o.post(s.api+"catalog/"+t.productId+"/rate",a).success(function(t){UIkit.notify(t.message,t.status)})},t.sendFb=function(e){o.post(s.api+"catalog/"+t.productId+"/feedback",e).success(function(e){UIkit.notify(e.message,e.status),"success"==e.status&&("P"==t.feedback.feedback_type?(t.catalog.feedback_plus.push(e.data),t.catalog.numPlus+=1):"N"==t.feedback.feedback_type&&(t.catalog.feedback_minus.push(e.data),t.catalog.numMinus+=1),t.feedback.feedback_type=""),t.feedback.feedback_comment=""})},t.respondFb=function(t,e,a){o.post(s.api+"feedback/"+e+"/respond/"+a).success(function(e){UIkit.notify(e.message,e.status),"success"==e.status&&productDetail.feedback_minus[t].plus_respond++})},t.setBlur=function(e){t.blur=e},t.navbarSubToggle=function(e){0==t.navbarSubShow?t.navbarSubShow=!0:t.navbarSubShow=!1,t.navbarSub=e},t.closeModal=function(){t.modal.hide()},$("#kg-modal").on({"show.uk.modal":function(){t.blur=!0},"hide.uk.modal":function(){t.$apply(function(){t.blur=!1}),t.modalTemplate=""}}),t.isLogin()?t.getAuthUser():t.refreshToken()||t.loginPage()}]).controller("catalogList",["$stateParams","$scope","$http","kgConfig",function(t,e,o,a){e.catalog={};var c=t.categoryId;if(null!=c)var n="catalog/category/"+c;else var n="catalog";o.get(a.api+n).success(function(t){e.catalog.list=t.lists})}]).controller("editCatalog",["$stateParams","$scope","$rootScope","$http","$sce","kgConfig",function(t,e,o,a,c,n){e.modal1=UIkit.modal("#cropmeModal"),e.modal2=UIkit.modal("#cropmeModal2"),e.addPreview=!1,e.preview={},a({method:"GET",url:n.api+"catalog/"+t.productId+"/edit"}).success(function(t){e.edit=t,e.edit.product=t.product[0],e.productId=e.edit.product.id,e.catInd=e.categories.map(function(t){return t.id}).indexOf(e.edit.product.category_id),e.categories=o.categories,$(".ui.checkbox").checkbox(),$(".ui.accordion").accordion("refresh"),$(".special.cards .image").dimmer({on:"hover"})}),e.selectCats=function(){e.catInd=$("#categoryId").prop("selectedIndex")-1},e.saveLogo=function(t,o){a.put(n.api+"catalog/"+e.productId+"/logo",{product_logo:t}).success(function(o){UIkit.notify(o.message,o.status),e.edit.product.product_logo=t})},e.savePreview=function(t){a.post(n.api+"catalog/"+e.productId+"/preview",t).success(function(t){UIkit.notify(t.message,t.status),e.addPreview=!1})},e.addCriteria=function(t){a.post(n.api+"catalog/"+e.productId+"/criteria",t).success(function(t){return"success"==t.status})},e.removeCriteria=function(t){return confirm("hapus kriteria?")?void a["delete"](n.api+"catalog/"+e.productId+"/criteria/"+t.id).success(function(t){return"success"==t.status?!0:void 0}):!1},e.addTag=function(t){a.post(n.api+"catalog/"+e.productId+"/tag",t).success(function(t){return"success"==t.status})},e.removeTag=function(t){return confirm("hapus tag?")?void a["delete"](n.api+"catalog/"+e.productId+"/tag/"+t.id).success(function(t){return"success"==t.status?!0:void 0}):!1},e.updateCatalog=function(t,o){var c={product_name:t.product_name,category_id:t.category_id,product_quote:t.product_quote,product_data:t.product_data,product_desc:t.product_desc,product_embed:t.product_embed};if(1==o){if(!confirm("simpan dan publikasikan?"))return!1;c.product_release=1}a.put(n.api+"catalog/"+e.productId,c).success(function(t){UIkit.notify(t.message,t.status)})},e.$on("cropme:done",function(t,o,c){var i=o.croppedImage;"cropme1"==c[0].id?a({method:"POST",url:n.files+"saveimage.php",data:i,headers:{"Content-Type":i.type}}).success(function(t){"success"==t.status&&(e.saveLogo(t.filename,i),e.modal1.hide())}):"cropme2"==c[0].id&&a({method:"POST",url:n.files+"savepreview.php",data:i,headers:{"Content-Type":i.type}}).success(function(t){"success"==t.status&&(e.addPreview=!0,e.preview.preview_pict=t.filename,e.modal2.hide())})})}]).controller("memberProfile",["$state","$stateParams","$scope","$rootScope","$http","kgConfig",function(t,e,o,a,c,n){o.cropMeModal=UIkit.modal("#cropMeModal"),c.get(n.api+e.username).success(function(t){o.profile=t,o.profile.member=t.user.member,o.profile.num_catalog=Object.keys(t.catalog).length,o.profile.num_collect=Object.keys(t.collect).length,o.profile.num_connect=Object.keys(t.connect).length,o.profile.num_contact=Object.keys(t.contact).length,o.profile.num_preview=Object.keys(t.preview).length})["catch"](function(e){t.go("home")}),o.savePict=function(t){c.put(n.api+a.user.name+"/pict",{user_pict:t}).success(function(e){UIkit.notify(e.message,e.status),o.cropMeModal.hide(),o.profile.user.user_pict=t})},o.addConnect=function(t){c.post(n.api+"connect/"+t).success(function(t){UIkit.notify(t.data.message,t.status)})},o.removeConnect=function(t){c["delete"](n.api+"connect/"+t).success(function(t){UIkit.notify(t.data.message,t.status)})},o.$on("cropme:done",function(t,e,a){var i=e.croppedImage;c({method:"POST",url:n.files+"saveavatar.php",data:i,headers:{"Content-Type":i.type}}).success(function(t){"success"==t.status&&o.savePict(t.filename,i)})})}]).controller("editMember",["$stateParams","$scope","$rootScope","$http","kgConfig",function(t,e,o,a,c){a({method:"GET",url:c.api+t.username+"/edit"}).success(function(t){e.profile=t,e.profile.member=t.user.member,e.profile.member.born=new Date(1e3*+e.profile.member.member_born),$(".ui.accordion").accordion("refresh")}),e.updateProfile=function(t){t.member_born=Date.parse(t.born)/1e3,a.put(c.api+o.user.name+"/profile",t).success(function(t){UIkit.notify(t.message,t.status)})},e.changeUser=function(t,e){"name"==t?data={name:e}:"email"==t?data={email:e}:"password"==t&&(data=e),a.put(c.api+o.user.name+"/"+t,data).success(function(t){UIkit.notify(t.data.success,t.status)})["catch"](function(t){UIkit.notify(t.data.error,t.status)})}}]).directive("ngEnter",function(){return function(t,e,o){e.bind("keydown keypress",function(e){13===e.which&&(t.$apply(function(){t.$eval(o.ngEnter)}),e.preventDefault())})}}).directive("stopEvent",function(){return{restrict:"A",link:function(t,e,o){e.on(o.stopEvent,function(t){t.stopPropagation()})}}}).directive("kgUiDropdown",function(){return function(t,e,o){e.dropdown()}}).directive("kgPopup",function(){return function(t,e){e.popup({variation:"inverted",position:"bottom center"})}}).directive("kgTab",function(){return function(t,e){e.tab()}}),function(t,e){var o="embedly-platform",a="script";if(!e.getElementById(o)){t.embedly=t.embedly||function(){(t.embedly.q=t.embedly.q||[]).push(arguments)};var c=e.createElement(a);c.id=o,c.async=1,c.src=("https:"===document.location.protocol?"https":"http")+"://cdn.embedly.com/widgets/platform.js";var n=e.getElementsByTagName(a)[0];n.parentNode.insertBefore(c,n)}}(window,document);